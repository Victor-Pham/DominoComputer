var DOMINO_WIDTH = 50;
var DOMINO_HEIGHT = 10;
var DOMINO_SHADOW = 40;

var gate_sketch = function (p) {
    p.setup = function () {
        var clientHeight = document.getElementById('and').clientHeight;
        p.createCanvas(clientHeight*1.6, clientHeight);                
        p.background(255);
        p.frameRate(60);
    }

    p.dominos = []
    p.starting = [];
    p.current = new Set()
    p.next = new Set()

    p.draw = function () {
        p.background(255)

        for (var i = p.dominos.length - 1; i >= 0; i--) {
            p.dominos[i].draw()
        }
    }

}

function reset(p) {
    p.dominos.forEach(function (d) {
        d.reset();
    })

    p.next.clear()
    p.current.clear()
}

function clearStarting(p){
    p.dominos.forEach(function (d){
        d.setStarting(false);
    });
}

function fall(p) {
    p.next.clear()
    var count = 0;
    p.current.forEach(function (d) {
        if (!d.isSideHit()) {
            d.topple()
            var neighbors = d.getNeighbors()
            if (neighbors.size === 0) {
                count++;

                if (count === p.current.size) {
                    end_fall();
                    count = 0;
                    p.current.clear();
                    console.log(p.current);
                }
            } else {
                neighbors.forEach(function (n) {
                    if (d.collide(n)) {
                        n.hitSide();
                    }
                    p.next.add(n);
                });
            }
        }
    });

    p.current.clear();

    p.next.forEach(function (n) {
        p.current.add(n)
    });
}

var intvl = null;

function fall_loop(p) {
    if (intvl !== null) {
        clearInterval(intvl);
    }
    for (var i = 0; i < p.dominos.length; i++) {
        if (p.dominos[i].isStarting()) {
            p.current.add(p.dominos[i])
        }
    }

    intvl = setInterval(function(){fall(p)}, 300);
}

function end_fall() {
    console.log("stopping")
    clearInterval(intvl)
}


var and_gate = new p5(gate_sketch, 'and-sketch')
var or_gate = new p5(gate_sketch, 'or-sketch')
var not_gate = new p5(gate_sketch, 'not-sketch')
var nand_gate = new p5(gate_sketch, 'nand-sketch')


and_dominos = [[340.8352191496308,412.14583587646484,3.141592653589793],[339.83464278075473,394.14583587646484,3.141592653589793],[338.8340664118786,370.14583587646484,3.141592653589793],[337.83349004300254,350.14583587646484,3.141592653589793],[336.8329136741265,328.14583587646484,3.141592653589793],[335.8323373052504,304.14583587646484,3.141592653589793],[144.72225084991896,415.14583587646484,3.141592653589793],[142.7210981121668,386.14583587646484,3.141592653589793],[140.71994537441464,357.14583587646484,3.141592653589793],[159.73089638306018,340.14583587646484,3.7699111843077517],[180.74300012945787,313.14583587646484,4.084070449666731],[208.75913845798814,294.14583587646484,4.39822971502571],[235.77470041764232,283.14583587646484,4.71238898038469],[267.7931442216769,282.14583587646484,4.71238898038469],[298.8110116568354,282.14583587646484,4.71238898038469],[329.8288790919939,281.14583587646484,4.71238898038469],[354.8432883138959,280.14583587646484,4.71238898038469],[383.8600030113023,280.14583587646484,4.71238898038469],[424.8836341352216,278.14583587646484,4.39822971502571],[467.90841799689304,260.14583587646484,4.084070449666731],[503.92916727643194,231.14583587646484,3.7699111843077517],[527.9430001294579,195.14583587646484,3.4557519189487724],[537.9487638182187,162.14583587646484,3.141592653589793],[536.9481874493426,132.8125,3.141592653589793],[107.70092520150398,320.4791679382324,2.5132741228718345],[90.6911269306106,304.4791679382324,2.827433388230814],[79.68478687297372,273.4791679382324,3.141592653589793],[77.68363413522155,244.47916793823242,3.141592653589793],[77.68363413522155,209.47916793823242,3.141592653589793],[77.68363413522155,177.47916793823242,3.141592653589793],[75.68248139746939,147.47916793823242,3.4557519189487724],[84.68766871735411,123.47916793823242,3.7699111843077517],[105.69977246375181,102.47916793823242,4.084070449666731],[135.71706353003424,85.47916793823242,4.39822971502571],[161.73204912081235,76.8125,4.71238898038469],[193.75049292484692,76.8125,4.71238898038469],[222.76720762225327,77.8125,4.71238898038469],[253.78507505741177,76.8125,4.71238898038469],[281.80121338594205,74.8125,4.71238898038469],[311.81850445222443,72.8125,4.71238898038469],[343.83694825625906,73.8125,4.71238898038469],[375.85539206029364,72.8125,4.71238898038469],[407.8738358643282,72.8125,4.71238898038469],[437.89112693061065,70.8125,4.71238898038469],[470.9101471035213,71.8125,4.71238898038469],[501.9280145386798,69.8125,4.71238898038469],[531.9453056049622,68.8125,4.71238898038469],[561.9625966712447,68.8125,4.71238898038469],[592.9804641064031,66.8125,4.71238898038469],[623.9983315415617,66.8125,4.71238898038469],[536.9481874493426,107.8125,3.141592653589793],[535.9476110804666,82.8125,3.141592653589793]];
or_dominos = [[67.08650850113254,125.23214292526245,4.71238898038469],[96.10075911538316,124.23214292526245,4.71238898038469],[125.11500972963377,124.23214292526245,4.71238898038469],[153.128768943393,123.23214292526245,4.71238898038469],[184.1440023586264,121.23214292526245,4.71238898038469],[213.15825297287702,131.23214292526245,4.71238898038469],[242.17250358712764,141.23214292526245,4.71238898038469],[272.1872456018697,152.23214292526245,4.71238898038469],[303.2024790171031,161.23214292526245,4.71238898038469],[334.2177124323365,172.23214292526245,4.71238898038469],[364.2324544470785,181.23214292526245,4.71238898038469],[394.2471964618205,191.23214292526245,4.71238898038469],[424.2619384765626,199.23214292526245,4.71238898038469],[454.2766804913046,209.23214292526245,4.71238898038469],[484.2914225060466,246.23214292526245,4.71238898038469],[514.3061645207886,246.23214292526245,4.71238898038469],[543.3204151350393,246.23214292526245,4.71238898038469],[573.3351571497813,246.23214292526245,4.71238898038469],[603.3498991645233,246.23214292526245,4.71238898038469],[632.3641497787739,246.23214292526245,4.71238898038469],[663.3793831940073,246.23214292526245,4.71238898038469],[692.393633808258,244.23214292526245,4.71238898038469],[71.08847410309814,372.23214292526245,4.71238898038469],[100.10272471734876,372.23214292526245,4.71238898038469],[130.11746673209078,374.23214292526245,4.71238898038469],[160.1322087468328,373.23214292526245,4.71238898038469],[188.145967960592,372.23214292526245,4.71238898038469],[217.16021857484265,362.23214292526245,4.71238898038469],[245.17397778860186,349.23214292526245,4.71238898038469],[275.1887198033439,339.23214292526245,4.71238898038469],[308.2049360195601,327.23214292526245,4.71238898038469],[337.2191866338107,319.23214292526245,4.71238898038469],[364.2324544470785,309.23214292526245,4.71238898038469],[394.2471964618205,299.23214292526245,4.71238898038469],[424.2619384765626,291.23214292526245,4.71238898038469],[455.277171891796,281.23214292526245,4.71238898038469]];
not_dominos = [[262.36176046176047,390.15625,-3.141592653589793],[261.36204906204904,359.15625,-3.141592653589793],[260.36233766233767,330.15625,-3.141592653589793],[260.36233766233767,301.15625,-3.141592653589793],[260.36233766233767,273.15625,-3.141592653589793],[259.3626262626263,243.15625,-3.141592653589793],[50.42294372294372,223.15625,-1.5707963267948966],[71.41688311688311,221.15625,-1.5707963267948966],[93.41053391053391,220.15625,-1.5707963267948966],[114.40447330447331,219.15625,-1.5707963267948966],[135.3984126984127,219.15625,-1.5707963267948966],[156.3923520923521,219.15625,-1.5707963267948966],[178.3860028860029,218.15625,-1.5707963267948966],[202.37907647907647,217.15625,-1.5707963267948966],[224.37272727272727,216.15625,-1.5707963267948966],[247.36608946608948,214.15625,-1.5707963267948966],[270.3594516594517,212.15625,-1.5707963267948966],[294.35252525252525,212.15625,-1.5707963267948966],[316.346176046176,210.15625,-1.5707963267948966],[335.3406926406926,210.15625,-1.5707963267948966],[356.334632034632,208.15625,-1.5707963267948966],[378.32828282828285,208.15625,-1.5707963267948966],[398.3225108225108,207.15625,-1.5707963267948966],[418.31673881673885,206.15625,-1.5707963267948966],[438.3109668109668,205.15625,-1.5707963267948966],[462.3040404040404,204.15625,-1.5707963267948966],[484.2976911976912,203.15625,-1.5707963267948966],[508.2907647907648,203.15625,-1.5707963267948966],[530.2844155844156,202.15625,-1.5707963267948966],[551.278354978355,202.15625,-1.5707963267948966],[572.2722943722944,201.15625,-1.5707963267948966],[594.2659451659451,201.15625,-1.5707963267948966]]
xor_dominos = [[79.88445243315736,406.7462100982666,-1.5707963267948966],[101.89644153397481,405.7462100982666,-1.5707963267948966],[124.90897559392032,404.7462100982666,-1.5707963267948966],[155.92586932689034,375.7462100982666,-1.5707963267948966],[185.9422181007323,374.7462100982666,-1.5707963267948966],[215.95856687457427,373.7462100982666,-1.5707963267948966],[245.97491564841624,372.7462100982666,-1.5707963267948966],[276.9918093813863,371.7462100982666,-1.5707963267948966],[307.0081581552283,371.7462100982666,-1.5707963267948966],[338.0250518881983,370.7462100982666,-1.5707963267948966],[370.0424905802964,370.7462100982666,-1.5707963267948966],[403.06047423152256,369.7462100982666,-1.5707963267948966],[434.07736796449257,369.7462100982666,-1.5707963267948966],[464.09371673833454,329.7462100982666,-1.5707963267948966],[499.11279030781685,326.7462100982666,-1.8849555921538759],[534.1318638772991,314.7462100982666,-2.199114857512855],[562.147122732885,293.7462100982666,-2.5132741228718345],[582.1580219154463,261.7462100982666,-2.827433388230814],[592.163471506727,224.7462100982666,-3.141592653589793],[590.1623815884708,187.92803955078125,-3.4557519189487724],[577.1552971198059,155.92803955078125,-3.7699111843077517],[554.1427630598604,127.92803955078125,-4.084070449666731],[522.1253243677623,111.92803955078125,-4.39822971502571],[486.105705839152,105.92803955078125,-4.71238898038469],[460.0915369018223,107.92803955078125,-4.71238898038469],[432.07627804623644,110.92803955078125,-4.71238898038469],[412.0653788636751,112.92803955078125,-4.39822971502571],[389.0528448037296,105.92803955078125,-4.084070449666731],[370.0424905802964,94.92803955078125,-3.7699111843077517],[352.03268131599117,79.92803955078125,-3.4557519189487724],[526.1275042042746,345.7462100982666,-4.71238898038469],[499.11279030781685,347.7462100982666,-4.71238898038469],[468.0958965748468,349.7462100982666,-4.71238898038469],[135.91497014432903,292.7462100982666,-4.71238898038469],[117.90516088002386,294.7462100982666,-4.39822971502571],[95.89317177920641,287.7462100982666,-4.084070449666731],[79.88445243315736,278.7462100982666,-3.7699111843077517],[63.87573308710832,261.7462100982666,-3.4557519189487724],[55.8713734140838,241.7462100982666,-3.141592653589793],[54.87082845495573,223.7462100982666,-2.827433388230814],[60.874098209724124,201.7462100982666,-2.5132741228718345],[73.88118267838898,184.7462100982666,-2.199114857512855],[87.88881210618189,170.7462100982666,-1.8849555921538759],[109.90080120699933,161.7462100982666,-1.5707963267948966],[138.91660502171322,161.7462100982666,-1.5707963267948966],[172.93513363206748,161.7462100982666,-1.8849555921538759],[204.95257232416557,148.7462100982666,-2.199114857512855],[231.96728622062332,125.7462100982666,-2.5132741228718345],[256.980910198825,98.7462100982666,-2.827433388230814],[301.00488840045983,69.7462100982666,-3.141592653589793],[299.0037984822037,46.7462100982666,-3.141592653589793]];
nor_dominos = [[22.5,179.2734375,-1.5707963267948966],[51.5,179.2734375,-1.5707963267948966],[80.5,178.2734375,-1.5707963267948966],[109.5,178.2734375,-1.5707963267948966],[137.5,179.2734375,-1.5707963267948966],[165.5,178.2734375,-1.5707963267948966],[195.5,177.2734375,-1.5707963267948966],[225.5,176.2734375,-1.5707963267948966],[254.5,174.2734375,-1.5707963267948966],[283.5,173.2734375,-1.5707963267948966],[312.5,172.2734375,-1.5707963267948966],[341.5,170.2734375,-1.5707963267948966],[371.5,168.2734375,-1.5707963267948966],[400.5,168.2734375,-1.5707963267948966],[431.5,167.2734375,-1.5707963267948966],[461.5,167.2734375,-1.5707963267948966],[492.5,167.2734375,-1.5707963267948966],[523.5,167.2734375,-1.5707963267948966],[553.5,166.2734375,-1.5707963267948966],[583.5,164.2734375,-1.5707963267948966],[613.5,162.2734375,-1.5707963267948966],[643.5,160.2734375,-1.5707963267948966],[328.5,194.2734375,-3.141592653589793],[328.5,211.2734375,-3.141592653589793],[288.5,240.2734375,-3.141592653589793],[275.5,272.2734375,-3.141592653589793],[263.5,305.2734375,-3.141592653589793],[253.5,335.2734375,-3.141592653589793],[253.5,371.2734375,-3.141592653589793],[252.5,404.2734375,-3.141592653589793],[364.5,240.2734375,-3.141592653589793],[374.5,273.2734375,-3.141592653589793],[386.5,302.2734375,-3.141592653589793],[399.5,331.2734375,-3.141592653589793],[398.5,367.2734375,-3.141592653589793],[398.5,402.2734375,-3.141592653589793]];
nand_dominos = [[238.5,402.8828125,3.141592653589793],[237.5,384.8828125,3.141592653589793],[257.5,374.8828125,3.4557519189487724],[263.5,361.8828125,3.7699111843077517],[274.5,345.8828125,4.084070449666731],[292.5,331.8828125,4.39822971502571],[313.5,324.8828125,4.71238898038469],[335.5,324.8828125,4.71238898038469],[364.5,323.8828125,4.71238898038469],[401.5,322.8828125,4.39822971502571],[434.5,309.8828125,4.084070449666731],[460.5,287.8828125,3.7699111843077517],[478.5,261.8828125,3.4557519189487724],[486.5,232.8828125,3.141592653589793],[486.5,211.8828125,3.141592653589793],[485.5,189.8828125,3.141592653589793],[483.5,168.8828125,3.141592653589793],[203.5,360.8828125,2.827433388230814],[195.5,346.8828125,3.141592653589793],[193.5,327.8828125,3.141592653589793],[191.5,307.8828125,3.141592653589793],[191.5,288.8828125,3.141592653589793],[190.5,266.8828125,3.141592653589793],[190.5,247.8828125,3.141592653589793],[190.5,226.8828125,3.141592653589793],[189.5,207.8828125,3.141592653589793],[188.5,191.8828125,3.4557519189487724],[193.5,175.8828125,3.7699111843077517],[203.5,162.8828125,4.084070449666731],[219.5,152.8828125,4.39822971502571],[239.5,145.8828125,4.71238898038469],[261.5,145.8828125,4.71238898038469],[283.5,145.8828125,4.71238898038469],[306.5,145.8828125,4.71238898038469],[330.5,144.8828125,4.71238898038469],[355.5,144.8828125,4.71238898038469],[376.5,143.8828125,4.71238898038469],[402.5,141.8828125,4.71238898038469],[425.5,140.8828125,4.71238898038469],[448.5,139.8828125,4.71238898038469],[466.5,137.8828125,4.71238898038469],[493.5,138.8828125,4.71238898038469],[513.5,138.8828125,4.71238898038469],[383.5,405.8828125,3.141592653589793],[383.5,386.8828125,3.141592653589793],[383.5,368.8828125,3.141592653589793],[381.5,352.8828125,3.141592653589793],[380.5,337.8828125,3.141592653589793],[70.5,415.8828125,3.141592653589793],[69.5,396.8828125,3.141592653589793],[69.5,379.8828125,3.141592653589793],[69.5,362.8828125,3.141592653589793],[69.5,343.8828125,3.141592653589793],[68.5,326.8828125,3.141592653589793],[66.5,307.8828125,3.141592653589793],[67.5,291.8828125,3.141592653589793],[67.5,268.8828125,3.141592653589793],[67.5,249.8828125,3.141592653589793],[67.5,228.8828125,3.141592653589793],[67.5,211.8828125,3.141592653589793],[66.5,195.8828125,3.141592653589793],[65.5,177.8828125,3.141592653589793],[65.5,159.8828125,3.141592653589793],[62.5,143.8828125,3.4557519189487724],[66.5,127.8828125,3.7699111843077517],[77.5,110.8828125,4.084070449666731],[90.5,99.8828125,4.39822971502571],[113.5,91.8828125,4.39822971502571],[138.5,82.8828125,4.39822971502571],[159.5,74.8828125,4.71238898038469],[183.5,75.8828125,4.71238898038469],[206.5,74.8828125,4.71238898038469],[228.5,73.8828125,4.71238898038469],[253.5,72.8828125,4.71238898038469],[275.5,71.8828125,4.71238898038469],[299.5,70.8828125,4.71238898038469],[323.5,70.8828125,4.71238898038469],[346.5,69.8828125,4.71238898038469],[370.5,69.8828125,4.71238898038469],[390.5,69.8828125,4.71238898038469],[412.5,69.8828125,4.71238898038469],[435.5,69.8828125,4.71238898038469],[459.5,67.8828125,4.71238898038469],[482.5,65.8828125,4.71238898038469],[506.5,65.8828125,4.71238898038469],[529.5,65.8828125,4.71238898038469],[547.5,65.8828125,5.026548245743669],[565.5,69.8828125,5.340707511102648],[581.5,78.8828125,5.654866776461628],[589.5,88.8828125,6.283185307179586],[590.5,103.8828125,6.283185307179586],[591.5,118.8828125,6.283185307179586],[592.5,138.8828125,6.283185307179586],[595.5,156.8828125,6.283185307179586],[598.5,175.8828125,6.283185307179586],[601.5,194.8828125,6.283185307179586],[603.5,210.8828125,6.283185307179586],[607.5,228.8828125,6.283185307179586],[609.5,247.8828125,6.283185307179586],[537.5,136.8828125,4.71238898038469],[567.5,136.8828125,4.71238898038469]];

function draw_gate(p, dominos){
    for (var i = 0; i < dominos.length; i++){
        p.dominos.push(new Domino(dominos[i][0], dominos[i][1], dominos[i][2], p))
    }

    for (var i = 0; i < dominos.length-1; i++){
        p.dominos[i].addNeighbor(p.dominos[i+1]);
    }

    if(p == and_gate){
        p.dominos[8].addNeighbor(p.dominos[24])
        p.dominos[23].addNeighbor(p.dominos[50])
        p.dominos[50].addNeighbor(p.dominos[44])
        p.dominos[50].addNeighbor(p.dominos[45])
        p.dominos[5].removeNeighbor(p.dominos[6])
        p.dominos[5].addNeighbor(p.dominos[14])
        p.dominos[5].addNeighbor(p.dominos[15])
    }

    if(p == or_gate){
        p.dominos[35].addNeighbor(p.dominos[14])
        p.dominos[21].removeNeighbor(p.dominos[22])
    }

    if(p == not_gate){
        p.dominos[5].addNeighbor(p.dominos[14])
        p.dominos[5].addNeighbor(p.dominos[15])
    }

    if(p == nand_gate){
        p.dominos[1].addNeighbor(p.dominos[17])
        p.dominos[42].addNeighbor(p.dominos[99])
        p.dominos[99].addNeighbor(p.dominos[100])
        p.dominos[47].addNeighbor(p.dominos[7])
        p.dominos[47].addNeighbor(p.dominos[8])
        p.dominos[16].addNeighbor(p.dominos[39])
        p.dominos[16].addNeighbor(p.dominos[40])
        p.dominos[100].addNeighbor(p.dominos[89])
        p.dominos[100].addNeighbor(p.dominos[90])
        p.dominos[100].addNeighbor(p.dominos[91])


        p.dominos[98].removeNeighbor(p.dominos[99])
    }

}

draw_gate(and_gate, and_dominos);
draw_gate(or_gate, or_dominos);
draw_gate(not_gate, not_dominos);
draw_gate(nand_gate, nand_dominos);

not_gate.dominos[6].setStarting(true);
nand_gate.dominos[48].setStarting(true);
